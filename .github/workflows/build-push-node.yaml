name: Build Push Node

on:
  workflow_call:
    secrets:
      LAMEDUSE_NPM_HOSTED_REGISTRY_USERNAME:
        required: true
        description: 'Lameduse registry username'
      LAMEDUSE_NPM_HOSTED_REGISTRY_PASSWORD:
        required: true
        description: 'Lameduse registry token'
      LAMEDUSE_NPM_HOSTED_REGISTRY:
        required: true
        description: 'Lameduse npm registry url'
    # vars:
    #   LAMEDUSE_NPM_HOSTED_REGISTRY:
    #     required: true
    #     description: 'Lameduse registry URL'

env:
  IMAGE_NAME: ${{ github.repository }}
  REGISTRY_URL: ${{ secrets.LAMEDUSE_NPM_HOSTED_REGISTRY }}

concurrency:
  group: build-push-node-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-npm-package:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        registry:
          - url: LAMEDUSE_NPM_HOSTED_REGISTRY
            auth-token-secret: LAMEDUSE_NPM_HOSTED_REGISTRY_PASSWORD
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Setup node environment (for publishing)
        uses: actions/setup-node@v3
        with:
          node-version: 22
          registry-url: ${{ secrets[matrix.registry.url] }}
          scope: "@lameduse"
      - name: Configure npm registry
        run: |
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
          echo "always-auth=true" >> ~/.npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets[matrix.registry.auth-token-secret] }}
      - name: Publish package
        run: |
          yarn && yarn build-lib || exit 1
          DATE=$(date +%Y%m%d%H%M%S)
          publish=(yarn publish --access=public --no-git-tag-version --non-interactive)
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            publish+=(--tag latest)
          else
            publish+=(--prerelease --preid next.$DATE --tag next)
          fi
          echo "ðŸš€ Publishing npm package with following command line: ${publish[@]}"
          "${publish[@]}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets[matrix.registry.auth-token-secret] }}
